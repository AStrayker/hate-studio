<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { auth, db, initBookmarkButton } from './js/app.js'; // Импорт из app.js

    const firebaseConfig = {
        apiKey: "AIzaSyB5X84s9PgkmnKt9nsNlsl5-mRyI06hexM",
        authDomain: "hate-studio.firebaseapp.com",
        projectId: "hate-studio",
        storageBucket: "hate-studio.firebasestorage.app",
        messagingSenderId: "862900757077",
        appId: "1:862900757077:web:ea1652b558a04235b1eadc",
        measurementId: "G-29V6NXRXMN"
    };

    const app = initializeApp(firebaseConfig);

    let currentUser = null;

    // Функция для показа уведомления
    function showNotification(message, type = 'success') {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification p-4 rounded-md mb-4 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
        notification.innerHTML = `<p>${message}</p>`;
        container.appendChild(notification);
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // Показывать/скрывать профиль только для авторизованных
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        const profileElements = document.querySelectorAll('#profile-link, #mobile-profile-link, #profile-dropdown-container');
        profileElements.forEach(el => {
            if (user) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        });
        if (document.getElementById('film-details')) {
            loadFilmData(); // Перезагрузить, если страница уже загружена
        }
    });

    // Получение рейтинга с IMDb
    async function getIMDBRating(imdbUrl) {
        try {
            const response = await fetch(imdbUrl);
            const html = await response.text();
            const match = html.match(/<span itemprop="ratingValue">([\d.]+)<\/span>/);
            return match ? parseFloat(match[1]).toFixed(1) : 'N/A';
        } catch (error) {
            console.error('Ошибка получения рейтинга:', error);
            return 'N/A';
        }
    }

    // Загрузка данных фильма
    async function loadFilmData() {
        const urlParams = new URLSearchParams(window.location.search);
        const filmId = urlParams.get('id');
        if (!filmId) {
            showNotification('ID фильма не найден.', 'error');
            return;
        }

        try {
            const docRef = doc(db, 'content', filmId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                const imdbRating = await getIMDBRating(data.mbLink || '');
                displayFilmData({ ...data, imdbRating }, filmId);
            } else {
                showNotification('Фильм не найден.', 'error');
            }
        } catch (error) {
            showNotification('Ошибка загрузки данных: ' + error.message, 'error');
        }
    }

    // Отображение данных фильма и инициализация кнопки закладок
    async function displayFilmData(data, filmId) {
        const container = document.getElementById('film-details');
        const contentType = data.type || 'Фильм'; // Определение типа контента
        const translationText = data.translation === 'dub' ? 'дубляж' : 'закадровый многоголосый';
        const duration = data.duration || '1ч 56м';
        const country = data.country || 'США';
        const rating = data.imdbRating !== 'N/A' ? data.imdbRating : (data.rating || 6.6);
        const genresList = data.genres ? data.genres.join(', ') : 'Боевик, Триллер, Комедия';
        const director = data.director || 'Уилл Паркер';
        const actors = data.actors || 'Джон Сина, Райан Рейнольдс, Приянка Чопра Джонс, Джек Блэк, Айдана Гловер, Карен Гиллан, Стивен Юн, Декстер Флетчер, Сара Хyland, Принс Харрис, Келан Линдси';

        // Кнопка закладок с иконкой
        const bookmarkButton = !currentUser
            ? '<button disabled class="bg-gray-600 text-white px-4 py-2 rounded-md cursor-not-allowed flex items-center"><span class="mr-2">Закладки</span><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></button>'
            : `<button id="bookmark-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors flex items-center"><span class="mr-2">Добавить</span><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></button>`;

        container.innerHTML = `
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex-shrink-0">
                    <img src="${data.posterUrl || 'placeholder-poster.jpg'}" alt="${data.title}" class="w-64 h-96 object-cover rounded-lg">
                    <div class="mt-4">
                        ${bookmarkButton}
                    </div>
                </div>
                <div class="flex-grow">
                    <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">${data.title}</h1>
                    <h2 class="text-xl text-gray-300 mb-4">${data.originalTitle || 'Heads of State (2025)'}</h2>
                    <div class="flex items-center mb-4">
                        <span class="text-yellow-400 mr-2">★ ${rating}</span>
                        <span class="text-gray-400">(${data.reviewsCount || '123'} отзывов)</span>
                    </div>
                    <div class="mb-4">
                        <p class="text-gray-300"><strong>Режиссёр:</strong> ${director}</p>
                    </div>
                    <div class="mb-4">
                        <p class="text-gray-300"><strong>Актёры:</strong> ${actors}</p>
                    </div>
                    <div class="mb-4">
                        <p class="text-gray-300"><strong>Жанры:</strong> ${genresList}</p>
                    </div>
                    <div class="mb-4">
                        <p class="text-gray-300"><strong>Страна:</strong> ${country}</p>
                    </div>
                    <div class="mb-4">
                        <p class="text-gray-300"><strong>Длительность:</strong> ${duration}</p>
                    </div>
                    <div class="mb-6">
                        <p class="text-gray-300"><strong>Синопсис ${translationText} от студии HATE Studio:</strong> ${data.description}</p>
                    </div>
                    ${data.videoUrl ? `<iframe src="${data.videoUrl}" class="w-full h-96" frameborder="0" allowfullscreen></iframe>` : ''}
                </div>
            </div>
        `;

        // Установка заголовка страницы
        document.title = `HATE Studio - ${data.title} (${contentType})`;

        // Инициализация кнопки закладок
        if (currentUser && document.getElementById('bookmark-btn')) {
            initBookmarkButton(filmId);
        }
    }

    // Мобильное меню
    document.getElementById('mobile-menu-button').addEventListener('click', () => {
        document.getElementById('main-nav').classList.add('open-menu');
        document.getElementById('mobile-menu-backdrop').classList.remove('hidden');
    });

    document.getElementById('close-mobile-menu-btn').addEventListener('click', () => {
        document.getElementById('main-nav').classList.remove('open-menu');
        document.getElementById('mobile-menu-backdrop').classList.add('hidden');
    });

    document.getElementById('mobile-menu-backdrop').addEventListener('click', () => {
        document.getElementById('main-nav').classList.remove('open-menu');
        document.getElementById('mobile-menu-backdrop').classList.add('hidden');
    });
</script>
<script type="module" src="js/app.js"></script>
