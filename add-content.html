<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HATE Studio - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüé¨%3C/text%3E%3C/svg%3E" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.5rem;
    }
    .season-group {
      border: 1px solid #374151;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
      background-color: #1f2937;
    }
    .episode-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .remove-btn {
      @apply bg-red-600 hover:bg-red-700 text-white text-xs px-2 py-1 rounded;
    }
    .add-btn {
      @apply bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded;
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <!-- Header (–≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à header –∏–∑ index.html) -->
  <header class="bg-gray-800 shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <a href="index.html" class="flex items-center">
        <img src="path/to/your/logo.png" alt="HATE Studio Logo" class="h-8 md:h-10">
      </a>
      <button id="mobile-menu-button" class="md:hidden text-white focus:outline-none z-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
        </svg>
      </button>

      <!-- Desktop Nav -->
      <nav class="hidden md:flex items-center space-x-6">
        <a href="index.html" class="text-white hover:text-orange-500">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="films.html" class="text-white hover:text-orange-500">–§–∏–ª—å–º—ã</a>
        <a href="series.html" class="text-white hover:text-orange-500">–°–µ—Ä–∏–∞–ª—ã</a>
        <a href="add-content.html" class="text-orange-500 font-bold">–î–æ–±–∞–≤–∏—Ç—å</a>
        <a href="login.html" id="login-btn-desktop" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">–í–æ–π—Ç–∏</a>
        <a href="#" id="logout-btn-desktop" class="hidden bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">–í—ã—Ö–æ–¥</a>
      </nav>

      <!-- Mobile Menu Backdrop -->
      <div id="mobile-menu-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    </div>
  </header>

  <main class="flex-grow container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl md:text-4xl font-bold text-orange-500 mb-8 text-center">
        <span id="page-title">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å–º –∏–ª–∏ —Å–µ—Ä–∏–∞–ª</span>
      </h1>

      <form id="content-form" class="bg-gray-800 p-6 md:p-8 rounded-xl shadow-xl space-y-6">
        <!-- –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
        <div>
          <label class="block text-gray-300 font-medium mb-2">–¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞</label>
          <select id="content-type" class="w-full px-4 py-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
            <option value="film">–§–∏–ª—å–º</option>
            <option value="series">–°–µ—Ä–∏–∞–ª</option>
          </select>
        </div>

        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
        <div>
          <label for="title" class="block text-gray-300 font-medium mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" id="title" required class="w-full px-4 py-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" />
        </div>

        <!-- –ì–æ–¥ –∏ –°—Ç—Ä–∞–Ω–∞ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="year" class="block text-gray-300 font-medium mb-2">–ì–æ–¥ –≤—ã—Ö–æ–¥–∞</label>
            <input type="number" id="year" min="1900" max="2100" class="w-full px-4 py-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" />
          </div>
          <div>
            <label for="country" class="block text-gray-300 font-medium mb-2">–°—Ç—Ä–∞–Ω–∞</label>
            <input type="text" id="country" class="w-full px-4 py-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" />
          </div>
        </div>

        <!-- –ñ–∞–Ω—Ä—ã -->
        <div>
          <label class="block text-gray-300 font-medium mb-2">–ñ–∞–Ω—Ä—ã</label>
          <div class="checkbox-grid">
            ${['–ë–æ–µ–≤–∏–∫', '–ö–æ–º–µ–¥–∏—è', '–î—Ä–∞–º–∞', '–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', '–£–∂–∞—Å—ã', '–¢—Ä–∏–ª–ª–µ—Ä', '–†–æ–º–∞–Ω—Ç–∏–∫–∞', '–î–µ—Ç–µ–∫—Ç–∏–≤', '–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è', '–ê–Ω–∏–º–µ', '–ú—É–ª—å—Ç—Ñ–∏–ª—å–º', '–î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π', '–ö—Ä–∏–º–∏–Ω–∞–ª'].map(genre => `
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" value="${genre}" class="genre-checkbox accent-orange-500">
                <span class="text-sm">${genre}</span>
              </label>
            `).join('')}
          </div>
        </div>

        <!-- –†–µ–∂–∏—Å—Å—ë—Ä –∏ –ê–∫—Ç—ë—Ä—ã -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="director" class="block text-gray-300 font-medium mb-2">–†–µ–∂–∏—Å—Å—ë—Ä</label>
            <input type="text" id="director" class="w-full px-4 py-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" />
          </div>
          <div>
            <label for="actors" class="block text-gray-300 font-medium mb-2">–ê–∫—Ç—ë—Ä—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
            <input type="text" id="actors" placeholder="–¢–æ–º –•—ç–Ω–∫—Å, –õ–µ–æ–Ω–∞—Ä–¥–æ –î–∏–ö–∞–ø—Ä–∏–æ" class="w-full px-4 py-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" />
          </div>
        </div>

        <!-- –ü–æ—Å—Ç–µ—Ä -->
        <div>
          <label class="block text-gray-300 font-medium mb-2">–ü–æ—Å—Ç–µ—Ä</label>
          <div class="flex flex-col md:flex-row gap-4">
            <input type="file" id="poster-file" accept="image/*" class="flex-1 px-4 py-2 bg-gray-700 text-white rounded-md" />
            <input type="url" id="poster-url" placeholder="–ò–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ URL –ø–æ—Å—Ç–µ—Ä–∞" class="flex-1 px-4 py-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" />
          </div>
          <div id="poster-preview" class="mt-4 h-64 bg-gray-700 rounded-lg overflow-hidden hidden">
            <img id="preview-img" class="w-full h-full object-cover" />
          </div>
        </div>

        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
        <div>
          <label for="description" class="block text-gray-300 font-medium mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="description" rows="4" required class="w-full px-4 py-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
        </div>

        <!-- IMDb —Å—Å—ã–ª–∫–∞ -->
        <div>
          <label for="imdb" class="block text-gray-300 font-medium mb-2">IMDb —Å—Å—ã–ª–∫–∞</label>
          <input type="url" id="imdb" placeholder="https://imdb.com/title/tt..." class="w-full px-4 py-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" />
        </div>

        <!-- –í–∏–¥–µ–æ (—Ñ–∏–ª—å–º) -->
        <div id="film-video-section">
          <label for="video-url" class="block text-gray-300 font-medium mb-2">–í–∏–¥–µ–æ (URL)</label>
          <input type="url" id="video-url" placeholder="https://youtube.com/watch?v=..." class="w-full px-4 py-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" />
        </div>

        <!-- –°–µ–∑–æ–Ω—ã (—Å–µ—Ä–∏–∞–ª) -->
        <div id="series-seasons-section" class="hidden">
          <div class="flex justify-between items-center mb-4">
            <label class="text-gray-300 font-medium">–°–µ–∑–æ–Ω—ã –∏ —ç–ø–∏–∑–æ–¥—ã</label>
            <button type="button" id="add-season-btn" class="add-btn">+ –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∑–æ–Ω</button>
          </div>
          <div id="seasons-container"></div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="flex justify-end space-x-4 pt-6">
          <a href="index.html" class="bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-700 transition-colors">–û—Ç–º–µ–Ω–∞</a>
          <button type="submit" id="submit-btn" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition-colors">
            –î–æ–±–∞–≤–∏—Ç—å
          </button>
        </div>
      </form>
    </div>
  </main>

  <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
  <div id="notification-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

  <script type="module">
    import { auth, db, storage } from './js/firebase-config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const urlParams = new URLSearchParams(window.location.search);
    const contentId = urlParams.get('id');
    let isEditMode = false;

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const form = document.getElementById('content-form');
    const typeSelect = document.getElementById('content-type');
    const filmVideoSection = document.getElementById('film-video-section');
    const seriesSeasonsSection = document.getElementById('series-seasons-section');
    const seasonsContainer = document.getElementById('seasons-container');
    const addSeasonBtn = document.getElementById('add-season-btn');
    const posterFile = document.getElementById('poster-file');
    const posterUrl = document.getElementById('poster-url');
    const previewContainer = document.getElementById('poster-preview');
    const previewImg = document.getElementById('preview-img');
    const submitBtn = document.getElementById('submit-btn');
    const pageTitle = document.getElementById('page-title');

    // –ñ–∞–Ω—Ä—ã
    const genres = ['–ë–æ–µ–≤–∏–∫', '–ö–æ–º–µ–¥–∏—è', '–î—Ä–∞–º–∞', '–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', '–£–∂–∞—Å—ã', '–¢—Ä–∏–ª–ª–µ—Ä', '–†–æ–º–∞–Ω—Ç–∏–∫–∞', '–î–µ—Ç–µ–∫—Ç–∏–≤', '–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è', '–ê–Ω–∏–º–µ', '–ú—É–ª—å—Ç—Ñ–∏–ª—å–º', '–î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π', '–ö—Ä–∏–º–∏–Ω–∞–ª'];

    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    function showNotification(type, message) {
      const container = document.getElementById('notification-container');
      const notification = document.createElement('div');
      notification.className = `p-4 rounded-lg shadow-xl text-white transition-all duration-300 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} translate-x-full`;
      notification.textContent = message;
      container.appendChild(notification);
      setTimeout(() => notification.classList.remove('translate-x-full'), 100);
      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞
    typeSelect.addEventListener('change', () => {
      const isSeries = typeSelect.value === 'series';
      filmVideoSection.classList.toggle('hidden', isSeries);
      seriesSeasonsSection.classList.toggle('hidden', !isSeries);
    });

    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å—Ç–µ—Ä–∞
    function updatePosterPreview() {
      const url = posterUrl.value.trim();
      const file = posterFile.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          previewImg.src = e.target.result;
          previewContainer.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      } else if (url) {
        previewImg.src = url;
        previewContainer.classList.remove('hidden');
      } else {
        previewContainer.classList.add('hidden');
      }
    }
    posterFile.addEventListener('change', updatePosterPreview);
    posterUrl.addEventListener('input', updatePosterPreview);

    // –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∑–æ–Ω
    let seasonCounter = 0;
    addSeasonBtn.addEventListener('click', () => {
      seasonCounter++;
      const seasonDiv = document.createElement('div');
      seasonDiv.className = 'season-group';
      seasonDiv.innerHTML = `
        <div class="flex justify-between items-center mb-3">
          <h4 class="font-bold text-orange-500">–°–µ–∑–æ–Ω ${seasonCounter}</h4>
          <button type="button" class="remove-btn remove-season">–£–¥–∞–ª–∏—Ç—å —Å–µ–∑–æ–Ω</button>
        </div>
        <div class="episodes-container space-y-2">
          <div class="episode-group">
            <input type="url" placeholder="URL —ç–ø–∏–∑–æ–¥–∞ 1" class="flex-1 px-3 py-2 bg-gray-700 text-white rounded-md text-sm" required />
            <button type="button" class="remove-btn remove-episode">√ó</button>
          </div>
        </div>
        <button type="button" class="add-btn mt-2 add-episode">+ –≠–ø–∏–∑–æ–¥</button>
      `;
      seasonsContainer.appendChild(seasonDiv);

      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ø–∏–∑–æ–¥–∞
      seasonDiv.querySelector('.add-episode').addEventListener('click', () => {
        const episodes = seasonDiv.querySelectorAll('.episode-group').length + 1;
        const epDiv = document.createElement('div');
        epDiv.className = 'episode-group';
        epDiv.innerHTML = `
          <input type="url" placeholder="URL —ç–ø–∏–∑–æ–¥–∞ ${episodes}" class="flex-1 px-3 py-2 bg-gray-700 text-white rounded-md text-sm" required />
          <button type="button" class="remove-btn remove-episode">√ó</button>
        `;
        seasonDiv.querySelector('.episodes-container').appendChild(epDiv);
        epDiv.querySelector('.remove-episode').addEventListener('click', () => epDiv.remove());
      });

      seasonDiv.querySelector('.remove-season').addEventListener('click', () => seasonDiv.remove());
      seasonDiv.querySelector('.remove-episode').addEventListener('click', () => seasonDiv.querySelector('.episode-group').remove());
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    async function loadForEdit(id) {
      try {
        const docSnap = await getDoc(doc(db, 'content', id));
        if (!docSnap.exists()) throw new Error('–ö–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');

        const data = docSnap.data();
        isEditMode = true;
        pageTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç';
        submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';

        document.getElementById('title').value = data.title || '';
        document.getElementById('content-type').value = data.type || 'film';
        document.getElementById('year').value = data.year || '';
        document.getElementById('country').value = data.country || '';
        document.getElementById('director').value = data.director || '';
        document.getElementById('actors').value = (data.actors || []).join(', ');
        document.getElementById('description').value = data.description || '';
        document.getElementById('imdb').value = data.mbLink || '';
        posterUrl.value = data.posterUrl || '';
        previewImg.src = data.posterUrl;
        previewContainer.classList.remove('hidden');

        // –ñ–∞–Ω—Ä—ã
        document.querySelectorAll('.genre-checkbox').forEach(cb => {
          cb.checked = (data.genres || []).includes(cb.value);
        });

        typeSelect.dispatchEvent(new Event('change'));

        if (data.type === 'film') {
          document.getElementById('video-url').value = data.videoUrl || '';
        } else if (data.type === 'series') {
          seasonsContainer.innerHTML = '';
          seasonCounter = 0;
          (data.seasons || []).forEach(season => {
            addSeasonBtn.click();
            const seasonDiv = seasonsContainer.lastElementChild;
            seasonDiv.querySelector('h4').textContent = `–°–µ–∑–æ–Ω ${season.seasonNumber}`;
            const container = seasonDiv.querySelector('.episodes-container');
            container.innerHTML = '';
            season.episodes.forEach(ep => {
              const epDiv = document.createElement('div');
              epDiv.className = 'episode-group';
              epDiv.innerHTML = `
                <input type="url" value="${ep.videoUrl}" class="flex-1 px-3 py-2 bg-gray-700 text-white rounded-md text-sm" required />
                <button type="button" class="remove-btn remove-episode">√ó</button>
              `;
              container.appendChild(epDiv);
              epDiv.querySelector('.remove-episode').addEventListener('click', () => epDiv.remove());
            });
          });
        }
      } catch (error) {
        showNotification('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
      }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!auth.currentUser) {
        showNotification('error', '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
        return;
      }

      try {
        const type = typeSelect.value;
        let posterUrl = posterUrl.value.trim();
        const file = posterFile.files[0];

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–µ—Ä–∞
        if (file) {
          const storageRef = ref(storage, `posters/${Date.now()}_${file.name}`);
          await uploadBytes(storageRef, file);
          posterUrl = await getDownloadURL(storageRef);
        }

        const data = {
          title: document.getElementById('title').value.trim(),
          type,
          year: document.getElementById('year').value || null,
          country: document.getElementById('country').value.trim() || null,
          director: document.getElementById('director').value.trim() || null,
          actors: document.getElementById('actors').value.split(',').map(a => a.trim()).filter(a => a),
          description: document.getElementById('description').value.trim(),
          mbLink: document.getElementById('imdb').value.trim() || null,
          posterUrl,
          genres: Array.from(document.querySelectorAll('.genre-checkbox:checked')).map(cb => cb.value),
          hidden: false
        };

        if (type === 'film') {
          data.videoUrl = document.getElementById('video-url').value.trim();
        } else {
          data.seasons = Array.from(seasonsContainer.querySelectorAll('.season-group')).map((s, i) => ({
            seasonNumber: i + 1,
            episodes: Array.from(s.querySelectorAll('.episode-group')).map(ep => ({
              episodeNumber: ep.parentNode.children.length,
              videoUrl: ep.querySelector('input').value.trim()
            }))
          }));
        }

        if (isEditMode) {
          await updateDoc(doc(db, 'content', contentId), data);
          showNotification('success', '–ö–æ–Ω—Ç–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—ë–Ω!');
        } else {
          await setDoc(doc(db, 'content'), data);
          showNotification('success', '–ö–æ–Ω—Ç–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω!');
          form.reset();
          previewContainer.classList.add('hidden');
        }
      } catch (error) {
        console.error(error);
        showNotification('error', '–û—à–∏–±–∫–∞: ' + error.message);
      }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = 'login.html';
    });

    if (contentId) {
      loadForEdit(contentId);
    }
  </script>
</body>
</html>
