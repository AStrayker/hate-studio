<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HATE Studio - Добавить контент</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'>plus%3C/text%3E%3C/svg%3E" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #main-nav.mobile-nav-visible { transform: translateX(0); }
        .genre-checkboxes { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.75rem; }
        @media (max-width: 640px) { .genre-checkboxes { grid-template-columns: repeat(2, 1fr); } }
        .season-group { border: 1px solid #4b5563; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; background-color: #1f2937; }
        .episode-input { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; }
        .episode-input input { flex: 1; }
        .preview-poster { max-width: 100%; height: auto; border-radius: 0.5rem; margin-top: 0.5rem; display: none; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

    <!-- HEADER — без изменений -->
    <header class="bg-gray-800 shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <a href="index.html" class="flex items-center">
                <div class="bg-orange-500 text-white font-bold text-xl w-10 h-10 flex items-center justify-center rounded-full">H</div>
            </a>
            <button id="mobile-menu-button" class="md:hidden text-white focus:outline-none z-50">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>

            <!-- Mobile menu -->
            <nav id="main-nav" class="fixed top-0 left-0 w-3/4 h-full transform -translate-x-full transition-transform duration-300 ease-in-out md:hidden flex flex-col justify-between p-6 z-40 bg-gray-800">
                <button id="close-mobile-menu-btn" class="absolute top-4 right-4 text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <div class="flex flex-col space-y-4 pt-12">
                    <a href="index.html" class="text-white hover:text-orange-500 font-bold text-lg">Главная</a>
                    <a href="films.html" class="text-white hover:text-orange-500 font-bold text-lg">Фильмы</a>
                    <a href="series.html" class="text-white hover:text-orange-500 font-bold text-lg">Сериалы</a>
                    <a href="bookmarks.html" class="text-white hover:text-orange-500 font-bold text-lg" id="mobile-bookmarks-link">Закладки</a>
                    <a href="profile.html" class="text-white hover:text-orange-500 font-bold text-lg" id="mobile-profile-link">Профиль</a>
                    <a href="users.html" class="text-white hover:text-orange-500 font-bold text-lg hidden" id="mobile-users-link">Пользователи</a>
                </div>
                <div class="flex flex-col items-center space-y-6 pb-4">
                    <div class="w-full h-px bg-gray-700"></div>
                    <a href="login.html" id="login-btn" class="w-full text-center bg-red-600 text-white py-3 rounded-md hover:bg-red-700 transition-colors font-bold">Войти</a>
                    <a href="#" id="logout-btn" class="cursor-pointer hidden bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">Выход</a>
                </div>
            </nav>

            <!-- Desktop menu -->
            <nav class="hidden md:flex md:flex-grow md:flex-row items-center justify-end space-x-6">
                <a href="index.html" class="nav-link cursor-pointer transition-colors duration-200 text-white hover:text-orange-500">Главная</a>
                <a href="films.html" class="nav-link cursor-pointer transition-colors duration-200 text-white hover:text-orange-500">Фильмы</a>
                <a href="series.html" class="nav-link cursor-pointer transition-colors duration-200 text-white hover:text-orange-500">Сериалы</a>
                <div class="relative group hidden md:block" id="profile-dropdown-container">
                    <a href="#" id="profile-link" class="nav-link cursor-pointer transition-colors duration-200 text-white hover:text-orange-500 flex items-center">
                        Профиль
                        <svg class="w-4 h-4 ml-1 transform transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </a>
                    <div id="profile-dropdown" class="absolute right-0 mt-2 w-48 bg-gray-700 rounded-md shadow-lg py-1 z-50 opacity-0 group-hover:opacity-100 transform scale-y-0 group-hover:scale-y-100 origin-top transition-all duration-300">
                        <a href="profile.html" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">Настройки профиля</a>
                        <a href="bookmarks.html" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600" id="desktop-bookmarks-link">Закладки</a>
                        <a href="users.html" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 hidden" id="desktop-users-link">Пользователи</a>
                    </div>
                </div>
                <a href="login.html" id="login-btn-desktop" class="nav-link cursor-pointer bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">Войти</a>
                <a href="#" id="logout-btn-desktop" class="cursor-pointer hidden bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">Выход</a>
            </nav>

            <div id="mobile-menu-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
        </div>
    </header>

    <!-- MAIN CONTENT — без изменений -->
    <main class="flex-grow container mx-auto px-4 py-8 flex items-center justify-center">
        <div class="w-full max-w-4xl bg-gray-800 rounded-xl shadow-2xl p-6 md:p-10">
            <h2 id="form-title" class="text-3xl md:text-4xl font-bold text-orange-500 mb-8 text-center">Добавить фильм</h2>

            <form id="content-form" class="space-y-6">
                <!-- ВСЯ ФОРМА — как было -->
                <!-- (оставь без изменений) -->
                <div>
                    <label for="content-type" class="block text-gray-300 font-medium mb-2">Тип:</label>
                    <select id="content-type" class="w-full px-4 py-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="film">Фильм</option>
                        <option value="series">Сериал</option>
                    </select>
                </div>
                <!-- ... остальная форма ... -->
                <!-- (вставь весь HTML формы из предыдущего ответа) -->
            </form>
        </div>
    </main>

    <footer class="bg-gray-800 py-4 text-center text-gray-400">
        <p class="text-sm">© 2025 HATE Studio. Все права защищены.</p>
    </footer>

    <div id="notification-container" class="fixed bottom-4 right-4 z-50"></div>

    <!-- app.js — ГЛАВНЫЙ, управляет авторизацией -->
    <script type="module" src="js/app.js"></script>

    <!-- Логика формы — БЕЗ currentUser и userRole -->
    <script type="module">
        import { db, storage, collection, addDoc, doc, updateDoc, getDoc, ref, uploadBytes, getDownloadURL } from './js/firebase-config.js';

        const editingId = new URLSearchParams(window.location.search).get('edit');
        const form = document.getElementById('content-form');
        const typeSelect = document.getElementById('content-type');
        const filmVideoSection = document.getElementById('film-video-section');
        const seriesSeasonsSection = document.getElementById('series-seasons-section');
        const seasonsContainer = document.getElementById('seasons-container');
        const addSeasonBtn = document.getElementById('add-season-btn');
        const posterFile = document.getElementById('poster-file');
        const posterUrl = document.getElementById('poster-url');
        const posterPreview = document.getElementById('poster-preview');
        const submitBtn = document.getElementById('submit-btn');
        const formTitle = document.getElementById('form-title');

        // Ждём, пока app.js установит window.currentUser и window.userRole
        document.addEventListener('userReady', async () => {
            const currentUser = window.currentUser;
            const userRole = window.userRole;

            // Загрузка для редактирования
            if (editingId && userRole === 'admin') {
                const docSnap = await getDoc(doc(db, 'content', editingId));
                if (docSnap.exists()) {
                    const d = docSnap.data();
                    formTitle.textContent = d.type === 'film' ? 'Редактировать фильм' : 'Редактировать сериал';
                    typeSelect.value = d.type;
                    typeSelect.dispatchEvent(new Event('change'));
                    document.getElementById('title').value = d.title;
                    document.getElementById('year').value = d.year;
                    document.getElementById('country').value = d.country;
                    document.getElementById('director').value = d.director;
                    document.getElementById('actors').value = d.actors?.join(', ') || '';
                    document.getElementById('description').value = d.description;
                    document.getElementById('imdb-link').value = d.imdbLink || '';
                    posterUrl.value = d.posterUrl;
                    posterPreview.src = d.posterUrl;
                    posterPreview.style.display = 'block';

                    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        cb.checked = d.genres?.includes(cb.value);
                    });

                    if (d.type === 'film') {
                        document.getElementById('video-url').value = d.videoUrl;
                    } else if (d.seasons) {
                        d.seasons.forEach(s => {
                            addSeasonBtn.click();
                            const seasonEl = seasonsContainer.lastElementChild;
                            seasonEl.querySelector('h4').textContent = `Сезон ${s.seasonNumber}`;
                            s.episodes.forEach((ep, i) => {
                                if (i > 0) seasonEl.querySelector('.add-episode').click();
                                seasonEl.querySelectorAll('.episode-input input')[i].value = ep.videoUrl;
                            });
                        });
                    }
                }
            }
        });

        // === ВСЯ ЛОГИКА ФОРМЫ (как раньше) ===
        // (вставь сюда весь код из предыдущего ответа: переключение типа, постер, сезоны, уведомления, submit)
        // НО БЕЗ `let currentUser` и `let userRole` — они берутся из window
    </script>
</body>
</html>
