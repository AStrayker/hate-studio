<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1HATE Studio - Добавить контент</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eplus%3C/text%3E%3C/svg%3E" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #main-nav.mobile-nav-visible { transform: translateX(0); }
        .genre-checkboxes { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.75rem; }
        @media (max-width: 640px) { .genre-checkboxes { grid-template-columns: repeat(2, 1fr); } }
        .season-group { border: 1px solid #4b5563; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; background-color: #1f2937; }
        .episode-input { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; }
        .episode-input input { flex: 1; }
        .preview-poster { max-width: 100%; height: auto; border-radius: 0.5rem; margin-top: 0.5rem; display: none; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

    <!-- === HEADER === -->
    <header class="bg-gray-800 shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <a href="index.html" class="flex items-center">
                <!-- Заглушка вместо logo.png -->
                <div class="bg-orange-500 text-white font-bold text-xl w-10 h-10 flex items-center justify-center rounded-full">
                    H
                </div>
            </a>
            <button id="mobile-menu-button" class="md:hidden text-white focus:outline-none z-50">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>

            <!-- Mobile menu -->
            <nav id="main-nav" class="fixed top-0 left-0 w-3/4 h-full transform -translate-x-full transition-transform duration-300 ease-in-out md:hidden flex flex-col justify-between p-6 z-40 bg-gray-800">
                <button id="close-mobile-menu-btn" class="absolute top-4 right-4 text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <div class="flex flex-col space-y-4 pt-12">
                    <a href="index.html" class="text-white hover:text-orange-500 font-bold text-lg">Главная</a>
                    <a href="films.html" class="text-white hover:text-orange-500 font-bold text-lg">Фильмы</a>
                    <a href="series.html" class="text-white hover:text-orange-500 font-bold text-lg">Сериалы</a>
                    <a href="bookmarks.html" class="text-white hover:text-orange-500 font-bold text-lg" id="mobile-bookmarks-link">Закладки</a>
                    <a href="profile.html" class="text-white hover:text-orange-500 font-bold text-lg" id="mobile-profile-link">Профиль</a>
                    <a href="users.html" class="text-white hover:text-orange-500 font-bold text-lg hidden" id="mobile-users-link">Пользователи</a>
                </div>
                <div class="flex flex-col items-center space-y-6 pb-4">
                    <div class="w-full h-px bg-gray-700"></div>
                    <a href="login.html" id="login-btn" class="w-full text-center bg-red-600 text-white py-3 rounded-md hover:bg-red-700 transition-colors font-bold">Войти</a>
                    <a href="#" id="logout-btn" class="cursor-pointer hidden bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">Выход</a>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-white"><svg class="w-8 h-8" viewBox="0 0 24 24" fill="none"><path d="M9.16666 12.8333L14.8333 7.16666M9.16666 12.8333L7.33332 17.6667L9.16666 12.8333ZM9.16666 12.8333L10.9999 14.6667L22.6667 4.66666L9.16666 12.8333ZM14.8333 7.16666L20.6667 12.9999L14.8333 7.16666Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a>
                        <a href="#" class="text-gray-400 hover:text-white"><svg class="w-8 h-8" viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM13.5 16.5C13.5 17.05 13.05 17.5 12.5 17.5H11.5C10.95 17.5 10.5 17.05 10.5 16.5V11.5C10.5 10.95 10.95 10.5 11.5 10.5H12.5C13.05 10.5 13.5 10.95 13.5 11.5V16.5ZM12 8.5C12.55 8.5 13 8.05 13 7.5V6.5C13 5.95 12.55 5.5 12 5.5C11.45 5.5 11 5.95 11 6.5V7.5C11 8.05 11.45 8.5 12 8.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a>
                        <a href="#" class="text-gray-400 hover:text-white"><svg class="w-8 h-8" viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM16 12C16 14.21 14.21 16 12 16C9.79 16 8 14.21 8 12C8 9.79 9.79 8 12 8C14.21 8 16 9.79 16 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a>
                        <a href="#" class="text-gray-400 hover:text-white"><svg class="w-8 h-8" viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM18 9H16.5C15.95 9 15.5 9.45 15.5 10V12H18.5V14H15.5V16.5C15.5 17.05 15.05 17.5 14.5 17.5H12.5C11.95 17.5 11.5 17.05 11.5 16.5V14.5C11.5 13.95 11.05 13.5 10.5 13.5H9.5C8.95 13.5 8.5 13.95 8.5 14.5V17.5C8.5 18.05 8.95 18.5 9.5 18.5H10.5C11.05 18.5 11.5 18.05 11.5 17.5V16.5H14.5C15.05 16.5 15.5 16.95 15.5 17.5V18.5C15.5 19.05 15.95 19.5 16.5 19.5H18.5C19.05 19.5 19.5 19.05 19.5 18.5V14.5C19.5 13.95 19.05 13.5 18.5 13.5H16.5C15.95 13.5 15.5 13.95 15.5 14.5V16.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a>
                    </div>
                </div>
            </nav>

            <!-- Desktop menu -->
            <nav class="hidden md:flex md:flex-grow md:flex-row items-center justify-end space-x-6">
                <a href="index.html" class="nav-link cursor-pointer transition-colors duration-200 text-white hover:text-orange-500">Главная</a>
                <a href="films.html" class="nav-link cursor-pointer transition-colors duration-200 text-white hover:text-orange-500">Фильмы</a>
                <a href="series.html" class="nav-link cursor-pointer transition-colors duration-200 text-white hover:text-orange-500">Сериалы</a>
                <div class="relative group hidden md:block" id="profile-dropdown-container">
                    <a href="#" id="profile-link" class="nav-link cursor-pointer transition-colors duration-200 text-white hover:text-orange-500 flex items-center">
                        Профиль
                        <svg class="w-4 h-4 ml-1 transform transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </a>
                    <div id="profile-dropdown" class="absolute right-0 mt-2 w-48 bg-gray-700 rounded-md shadow-lg py-1 z-50 opacity-0 group-hover:opacity-100 transform scale-y-0 group-hover:scale-y-100 origin-top transition-all duration-300">
                        <a href="profile.html" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">Настройки профиля</a>
                        <a href="bookmarks.html" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600" id="desktop-bookmarks-link">Закладки</a>
                        <a href="users.html" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 hidden" id="desktop-users-link">Пользователи</a>
                    </div>
                </div>
                <a href="login.html" id="login-btn-desktop" class="nav-link cursor-pointer bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">Войти</a>
                <a href="#" id="logout-btn-desktop" class="cursor-pointer hidden bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">Выход</a>
            </nav>

            <div id="mobile-menu-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
        </div>
    </header>

    <!-- === MAIN CONTENT === -->
    <main class="flex-grow container mx-auto px-4 py-8 flex items-center justify-center">
        <div class="w-full max-w-4xl bg-gray-800 rounded-xl shadow-2xl p-6 md:p-10">
            <h2 id="form-title" class="text-3xl md:text-4xl font-bold text-orange-500 mb-8 text-center">Добавить фильм</h2>

            <form id="content-form" class="space-y-6">
                <!-- Тип контента -->
                <div>
                    <label for="content-type" class="block text-gray-300 font-medium mb-2">Тип:</label>
                    <select id="content-type" class="w-full px-4 py-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="film">Фильм</option>
                        <option value="series">Сериал</option>
                    </select>
                </div>

                <!-- Постер -->
                <div>
                    <label class="block text-gray-300 font-medium mb-2">Постер:</label>
                    <input type="file" id="poster-file" accept="image/*" class="w-full px-4 py-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 mb-2">
                    <p class="text-gray-400 text-sm mb-1">или</p>
                    <input type="url" id="poster-url" placeholder="Вставьте URL постера" class="w-full px-4 py-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <img id="poster-preview" class="preview-poster" alt="Предпросмотр постера">
                </div>

                <!-- Название -->
                <div>
                    <label for="title" class="block text-gray-300 font-medium mb-2">Название:</label>
                    <input type="text" id="title" required class="w-full px-4 py-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>

                <!-- Год и страна -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="year" class="block text-gray-300 font-medium mb-2">Год выхода:</label>
                        <input type="number" id="year" min="1900" max="2100" required class="w-full px-4 py-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label for="country" class="block text-gray-300 font-medium mb-2">Страна:</label>
                        <input type="text" id="country" required class="w-full px-4 py-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>

                <!-- Жанры -->
                <div>
                    <label class="block text-gray-300 font-medium mb-2">Жанры:</label>
                    <div class="genre-checkboxes">
                        <label class="flex items-center"><input type="checkbox" value="Боевик" class="mr-2"><span>Боевик</span></label>
                        <label class="flex items-center"><input type="checkbox" value="Комедия" class="mr-2"><span>Комедия</span></label>
                        <label class="flex items-center"><input type="checkbox" value="Драма" class="mr-2"><span>Драма</span></label>
                        <label class="flex items-center"><input type="checkbox" value="Фантастика" class="mr-2"><span>Фантастика</span></label>
                        <label class="flex items-center"><input type="checkbox" value="Ужасы" class="mr-2"><span>Ужасы</span></label>
                        <label class="flex items-center"><input type="checkbox" value="Триллер" class="mr-2"><span>Триллер</span></label>
                        <label class="flex items-center"><input type="checkbox" value="Романтика" class="mr-2"><span>Романтика</span></label>
                        <label class="flex items-center"><input type="checkbox" value="Приключения" class="mr-2"><span>Приключения</span></label>
                        <label class="flex items-center"><input type="checkbox" value="Детектив" class="mr-2"><span>Детектив</span></label>
                        <label class="flex items-center"><input type="checkbox" value="Фэнтези" class="mr-2"><span>Фэнтези</span></label>
                        <label class="flex items-center"><input type="checkbox" value="Аниме" class="mr-2"><span>Аниме</span></label>
                        <label class="flex items-center"><input type="checkbox" value="Документальный" class="mr-2"><span>Документальный</span></label>
                        <label class="flex items-center"><input type="checkbox" value="Мультфильм" class="mr-2"><span>Мультфильм</span></label>
                    </div>
                </div>

                <!-- Режиссёр -->
                <div>
                    <label for="director" class="block text-gray-300 font-medium mb-2">Режиссёр:</label>
                    <input type="text" id="director" required class="w-full px-4 py-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>

                <!-- Актёры -->
                <div>
                    <label for="actors" class="block text-gray-300 font-medium mb-2">Актёры (через запятую):</label>
                    <input type="text" id="actors" placeholder="Том Хэнкс, Мeryl Streep" class="w-full px-4 py-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>

                <!-- Описание -->
                <div>
                    <label for="description" class="block text-gray-300 font-medium mb-2">Описание:</label>
                    <textarea id="description" rows="4" required class="w-full px-4 py-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
                </div>

                <!-- Ссылка на IMDb -->
                <div>
                    <label for="imdb-link" class="block text-gray-300 font-medium mb-2">Ссылка на IMDb:</label>
                    <input type="url" id="imdb-link" class="w-full px-4 py-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>

                <!-- Видео (фильм) -->
                <div id="film-video-section">
                    <label for="video-url" class="block text-gray-300 font-medium mb-2">Ссылка на видео:</label>
                    <input type="url" id="video-url" class="w-full px-4 py-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>

                <!-- Сезоны (сериал) -->
                <div id="series-seasons-section" class="hidden">
                    <label class="block text-gray-300 font-medium mb-2">Сезоны:</label>
                    <div id="seasons-container"></div>
                    <button type="button" id="add-season-btn" class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 transition-colors">Добавить сезон</button>
                </div>

                <!-- Кнопки -->
                <div class="flex justify-center space-x-4 pt-6">
                    <button type="reset" class="bg-gray-600 text-white px-6 py-3 rounded-md hover:bg-gray-700 transition-colors">Очистить</button>
                    <button type="submit" id="submit-btn" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition-colors">Добавить</button>
                </div>
            </form>
        </div>
    </main>

    <!-- === FOOTER === -->
    <footer class="bg-gray-800 py-4 text-center text-gray-400">
        <p class="text-sm">© 2025 HATE Studio. Все права защищены.</p>
    </footer>

    <!-- === Уведомления === -->
    <div id="notification-container" class="fixed bottom-4 right-4 z-50"></div>

    <!-- === Firebase SDK (v10+) === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // === ТВОЯ КОНФИГУРАЦИЯ FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyB5X84s9PgkmnKt9nsNlsl5-mRyI06hexM",
  authDomain: "hate-studio.firebaseapp.com",
  projectId: "hate-studio",
  storageBucket: "hate-studio.firebasestorage.app",
  messagingSenderId: "862900757077",
  appId: "1:862900757077:web:ea1652b558a04235b1eadc",
  measurementId: "G-29V6NXRXMN"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUser = null;
        let userRole = 'guest';
        let editingId = new URLSearchParams(window.location.search).get('edit');

        const form = document.getElementById('content-form');
        const typeSelect = document.getElementById('content-type');
        const filmVideoSection = document.getElementById('film-video-section');
        const seriesSeasonsSection = document.getElementById('series-seasons-section');
        const seasonsContainer = document.getElementById('seasons-container');
        const addSeasonBtn = document.getElementById('add-season-btn');
        const posterFile = document.getElementById('poster-file');
        const posterUrl = document.getElementById('poster-url');
        const posterPreview = document.getElementById('poster-preview');
        const submitBtn = document.getElementById('submit-btn');
        const formTitle = document.getElementById('form-title');

        // Переключение типа
        typeSelect.addEventListener('change', () => {
            const isSeries = typeSelect.value === 'series';
            filmVideoSection.classList.toggle('hidden', isSeries);
            seriesSeasonsSection.classList.toggle('hidden', !isSeries);
            submitBtn.textContent = isSeries ? 'Добавить сериал' : 'Добавить фильм';
            formTitle.textContent = isSeries ? 'Добавить сериал' : 'Добавить фильм';
        });

        // Предпросмотр постера
        posterFile.addEventListener('change', () => {
            const file = posterFile.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    posterPreview.src = e.target.result;
                    posterPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        posterUrl.addEventListener('input', () => {
            if (posterUrl.value.trim()) {
                posterPreview.src = posterUrl.value;
                posterPreview.style.display = 'block';
            } else {
                posterPreview.style.display = 'none';
            }
        });

        // Добавление сезона
        addSeasonBtn.addEventListener('click', () => {
            const seasonNum = seasonsContainer.children.length + 1;
            const seasonHtml = `
                <div class="season-group">
                    <h4 class="text-lg font-bold mb-2 text-orange-500">Сезон ${seasonNum}</h4>
                    <div class="episodes-container space-y-2">
                        <div class="episode-input">
                            <input type="url" placeholder="URL эпизода 1" class="px-3 py-2 bg-gray-700 text-white rounded-md flex-1">
                            <button type="button" class="remove-episode bg-red-600 text-white px-2 py-1 rounded-md hover:bg-red-700">Удалить</button>
                        </div>
                    </div>
                    <button type="button" class="add-episode mt-2 bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700 text-sm">Добавить эпизод</button>
                    <button type="button" class="remove-season mt-2 ml-2 bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 text-sm">Удалить сезон</button>
                </div>
            `;
            seasonsContainer.insertAdjacentHTML('beforeend', seasonHtml);

            const seasonEl = seasonsContainer.lastElementChild;
            seasonEl.querySelector('.add-episode').addEventListener('click', () => {
                const epNum = seasonEl.querySelectorAll('.episode-input').length + 1;
                const epHtml = `<div class="episode-input">
                    <input type="url" placeholder="URL эпизода ${epNum}" class="px-3 py-2 bg-gray-700 text-white rounded-md flex-1">
                    <button type="button" class="remove-episode bg-red-600 text-white px-2 py-1 rounded-md hover:bg-red-700">Удалить</button>
                </div>`;
                seasonEl.querySelector('.episodes-container').insertAdjacentHTML('beforeend', epHtml);
                seasonEl.querySelectorAll('.remove-episode').forEach(btn => btn.onclick = () => btn.parentElement.remove());
            });

            seasonEl.querySelector('.remove-season').onclick = () => seasonEl.remove();
            seasonEl.querySelectorAll('.remove-episode').forEach(btn => btn.onclick = () => btn.parentElement.remove());
        });

        // Уведомления
        function showNotification(type, message) {
            const container = document.getElementById('notification-container');
            const notif = document.createElement('div');
            notif.className = `p-4 rounded-lg shadow-xl text-white mb-2 w-80 transition-all duration-500 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} opacity-0 translate-x-full`;
            notif.textContent = message;
            container.appendChild(notif);
            setTimeout(() => notif.classList.remove('opacity-0', 'translate-x-full'), 10);
            setTimeout(() => {
                notif.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => notif.remove(), 500);
            }, 4000);
        }

        // Отправка формы
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser || userRole !== 'admin') {
                showNotification('error', 'Только админ может добавлять контент!');
                return;
            }

            let posterUrlValue = posterUrl.value.trim();
            if (posterFile.files[0]) {
                try {
                    const fileRef = ref(storage, `posters/${Date.now()}_${posterFile.files[0].name}`);
                    await uploadBytes(fileRef, posterFile.files[0]);
                    posterUrlValue = await getDownloadURL(fileRef);
                } catch (err) {
                    showNotification('error', 'Ошибка загрузки постера');
                    return;
                }
            }

            const genres = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);

            const data = {
                type: typeSelect.value,
                title: document.getElementById('title').value.trim(),
                year: parseInt(document.getElementById('year').value),
                country: document.getElementById('country').value.trim(),
                genres,
                director: document.getElementById('director').value.trim(),
                actors: document.getElementById('actors').value.split(',').map(a => a.trim()).filter(a => a),
                description: document.getElementById('description').value.trim(),
                imdbLink: document.getElementById('imdb-link').value.trim() || null,
                posterUrl: posterUrlValue,
                hidden: false,
                rating: 0
            };

            if (typeSelect.value === 'film') {
                data.videoUrl = document.getElementById('video-url').value.trim();
            } else {
                data.seasons = [];
                seasonsContainer.querySelectorAll('.season-group').forEach(seasonEl => {
                    const seasonNum = seasonEl.querySelector('h4').textContent.match(/\d+/)[0];
                    const episodes = [];
                    seasonEl.querySelectorAll('.episode-input input').forEach(inp => {
                        if (inp.value.trim()) episodes.push({ episodeNumber: episodes.length + 1, videoUrl: inp.value.trim() });
                    });
                    if (episodes.length > 0) data.seasons.push({ seasonNumber: parseInt(seasonNum), episodes });
                });
            }

            try {
                if (editingId) {
                    await updateDoc(doc(db, 'content', editingId), data);
                    showNotification('success', 'Контент обновлён!');
                    setTimeout(() => window.location.href = 'add-content.html', 1500);
                } else {
                    await addDoc(collection(db, 'content'), data);
                    showNotification('success', typeSelect.value === 'film' ? 'Фильм добавлен!' : 'Сериал добавлен!');
                    form.reset();
                    posterPreview.style.display = 'none';
                    seasonsContainer.innerHTML = '';
                }
            } catch (err) {
                console.error(err);
                showNotification('error', 'Ошибка сохранения');
            }
        });

        // Проверка авторизации и загрузка для редактирования
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                userRole = userDoc.exists() ? userDoc.data().role : 'guest';
            }

            if (editingId && userRole === 'admin') {
                const docSnap = await getDoc(doc(db, 'content', editingId));
                if (docSnap.exists()) {
                    const d = docSnap.data();
                    formTitle.textContent = d.type === 'film' ? 'Редактировать фильм' : 'Редактировать сериал';
                    typeSelect.value = d.type;
                    typeSelect.dispatchEvent(new Event('change'));
                    document.getElementById('title').value = d.title;
                    document.getElementById('year').value = d.year;
                    document.getElementById('country').value = d.country;
                    document.getElementById('director').value = d.director;
                    document.getElementById('actors').value = d.actors?.join(', ') || '';
                    document.getElementById('description').value = d.description;
                    document.getElementById('imdb-link').value = d.imdbLink || '';
                    posterUrl.value = d.posterUrl;
                    posterPreview.src = d.posterUrl;
                    posterPreview.style.display = 'block';

                    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        cb.checked = d.genres?.includes(cb.value);
                    });

                    if (d.type === 'film') {
                        document.getElementById('video-url').value = d.videoUrl;
                    } else if (d.seasons) {
                        d.seasons.forEach(s => {
                            addSeasonBtn.click();
                            const seasonEl = seasonsContainer.lastElementChild;
                            seasonEl.querySelector('h4').textContent = `Сезон ${s.seasonNumber}`;
                            s.episodes.forEach((ep, i) => {
                                if (i > 0) seasonEl.querySelector('.add-episode').click();
                                seasonEl.querySelectorAll('.episode-input input')[i].value = ep.videoUrl;
                            });
                        });
                    }
                }
            }
        });
    </script>

<script type="module" src="js/app.js"></script>
</body>
</html>
